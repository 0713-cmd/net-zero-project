import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import os

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="COWAY Net-Zero Dashboard", page_icon="ğŸŒ¿", layout="wide")
st.markdown("""
<style>
    .stApp { background-color: #0E1117; color: #FAFAFA; font-family: 'Suit', sans-serif; }
    .info-box { background-color: #1F252E; border: 1px solid #30363D; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .box-title { color: #2BD6B4; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
    .box-content { color: #E6E6E6; font-size: 16px; line-height: 1.6; white-space: pre-line; }
    [data-testid="stStatusWidget"] { visibility: hidden; }
</style>
""", unsafe_allow_html=True)

# 2. ë°ì´í„° ë¡œë“œ (ë¬´ì¡°ê±´ data.csv ì½ê¸°)
@st.cache_data(show_spinner=False)
def load_data():
    if not os.path.exists('data.csv'):
        return None
    try:
        return pd.read_csv('data.csv', header=None, encoding='utf-8')
    except:
        return pd.read_csv('data.csv', header=None, encoding='cp949')

df_raw = load_data()

if df_raw is None:
    st.error("ğŸš¨ 'data.csv' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GitHubì— íŒŒì¼ì´ ì˜¬ë¼ê°”ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.stop()

# 3. ë°ì´í„° ë§¤í•‘ (ì—‘ì…€ í–‰ë²ˆí˜¸ ê·¸ëŒ€ë¡œ ì ìš©)
# ì—°ë„: 2í–‰(Index 1)ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ (2023~2050)
years_row = df_raw.iloc[1, :].tolist()
valid_indices = []
years = []
for i, val in enumerate(years_row):
    s = str(val).replace('.0', '').replace(',', '')
    if s.isdigit() and 2023 <= int(s) <= 2050:
        valid_indices.append(i)
        years.append(s)

# ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜
def get_vals(row_idx): # ì—‘ì…€ í–‰ë²ˆí˜¸ ë„£ìœ¼ë©´ ë¨
    if row_idx-1 >= len(df_raw): return [0]*len(years)
    raw = df_raw.iloc[row_idx-1, valid_indices].tolist()
    clean = []
    for v in raw:
        try: clean.append(float(str(v).replace(',', '')))
        except: clean.append(0.0)
    return clean

def get_text(row_idx):
    if row_idx-1 >= len(df_raw): return [""]*len(years)
    return [str(v) if str(v) != 'nan' else "" for v in df_raw.iloc[row_idx-1, valid_indices].tolist()]

def get_title(row_idx):
    return str(df_raw.iloc[row_idx-1, 0])

# ë°ì´í„° ì¤€ë¹„
title1 = get_title(1)
expected = get_vals(4) # 4í–‰ ì˜ˆìƒë°°ì¶œëŸ‰
target = get_vals(3)   # 3í–‰ ëª©í‘œë°°ì¶œëŸ‰
inv_red = get_vals(6)  # 6í–‰ íˆ¬ìê°ì¶•ëŸ‰
rec_red = get_vals(7)  # 7í–‰ RECê°ì¶•ëŸ‰

title2 = get_title(8)
g2_rows = range(10, 15) # 10~14í–‰
g2_labels = [str(df_raw.iloc[r-1, 0]) for r in g2_rows]
g2_data = [get_vals(r) for r in g2_rows]

title3 = get_title(16)
g3_rows = range(17, 22) # 17~21í–‰
g3_labels = [str(df_raw.iloc[r-1, 0]) for r in g3_rows]
g3_data = [get_vals(r) for r in g3_rows]

box1 = get_text(15)
box2 = get_text(23)

ft1 = get_title(40) if len(df_raw) >= 40 else ""
fc1 = get_title(41) if len(df_raw) >= 41 else "" # ì—‘ì…€ 41í–‰ì„ ë‚´ìš©ìœ¼ë¡œ
ft2 = get_title(42) if len(df_raw) >= 42 else ""
fc2 = get_title(43) if len(df_raw) >= 43 else "" 

# 4. ì‹œê°í™”
st.title("COWAY Net-Zero Roadmap Dashboard")

# ê·¸ë˜í”„ 1
st.subheader(f"1. {title1}")
fig1 = go.Figure()
fig1.add_trace(go.Scatter(x=years, y=expected, name='ì˜ˆìƒ ë°°ì¶œëŸ‰', line=dict(color='#8B949E', width=2, dash='dash')))
fig1.add_trace(go.Scatter(x=years, y=target, name='ëª©í‘œ ë°°ì¶œëŸ‰', line=dict(color='#2BD6B4', width=4)))
fig1.add_trace(go.Bar(x=years, y=inv_red, name='íˆ¬ì ê°ì¶•ëŸ‰', marker_color='#1E90FF'))
fig1.add_trace(go.Bar(x=years, y=rec_red, name='REC ê°ì¶•ëŸ‰', marker_color='#FFD700'))
fig1.update_layout(template="plotly_dark", barmode='stack', height=500, hovermode="x unified")
st.plotly_chart(fig1, use_container_width=True)

# ê·¸ë˜í”„ 2
st.markdown("---")
st.subheader(f"2. {title2}")
fig2 = go.Figure()
colors = px.colors.qualitative.Pastel
for i, l in enumerate(g2_labels):
    fig2.add_trace(go.Bar(x=years, y=g2_data[i], name=l, marker_color=colors[i%len(colors)]))
fig2.update_layout(template="plotly_dark", barmode='stack', height=500, hovermode="x unified")
st.plotly_chart(fig2, use_container_width=True)

# ê·¸ë˜í”„ 3
st.markdown("---")
st.subheader(f"3. {title3}")
fig3 = go.Figure()
for i, l in enumerate(g3_labels):
    fig3.add_trace(go.Bar(x=years, y=g3_data[i], name=l))
fig3.update_layout(template="plotly_dark", barmode='group', height=500, hovermode="x unified")
st.plotly_chart(fig3, use_container_width=True)

# ë°•ìŠ¤ ì˜ì—­
st.markdown("---")
st.subheader("ğŸ“… ì—°ë„ë³„ ìƒì„¸ ë¶„ì„")
sel_year = st.select_slider("ì—°ë„ ì„ íƒ", options=years, value="2030")
idx = years.index(sel_year)

c1, c2 = st.columns(2)
with c1: st.markdown(f'<div class="info-box"><div class="box-title">ğŸ“Œ {sel_year}ë…„ ì´ìŠˆ</div><div class="box-content">{box1[idx]}</div></div>', unsafe_allow_html=True)
with c2: st.markdown(f'<div class="info-box"><div class="box-title">ğŸ’° {sel_year}ë…„ íˆ¬ì</div><div class="box-content">{box2[idx]}</div></div>', unsafe_allow_html=True)

# í•˜ë‹¨ ìš©ì–´
st.markdown("---")
f1, f2 = st.columns(2)
with f1: 
    if ft1: st.info(f"**{ft1}**\n\n{fc1}")
with f2:
    if ft2: st.info(f"**{ft2}**\n\n{fc2}")